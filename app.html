<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Image Classifier test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .wrap { max-width: 720px; margin: 0 auto; }
    header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    header a { text-decoration:none; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:12px 0; }
    .status { margin-top: 8px; font-size: 14px; color: #555; }
    video, canvas, img { max-width:100%; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.12); }
    button, input[type=file] { padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a href="index.html">← Home</a>
      <h1 style="margin:0;">Image Classifier</h1>
    </header>

    <p>Select a photo or use your camera. The model predicts **Fruit** vs **Vegetable**.</p>

    <div class="row">
      <input id="file" type="file" accept="image/*">
      <button id="cameraBtn" disabled>Use Camera</button>
      <button id="stopBtn" disabled>Stop Camera</button>
    </div>

    <video id="video" playsinline autoplay muted style="display:none;"></video>
    <canvas id="canvas" width="320" height="320" aria-label="preview"></canvas>

    <div class="status" id="label">Label: (loading model…)</div>
    <div class="status" id="prob">Confidence: —</div>

    <noscript><p><strong>JavaScript is required.</strong></p></noscript>
  </div>

  <!-- Load libraries FIRST (exact versions for compatibility) -->
  <script src="https://unpkg.com/@tensorflow/tfjs@1.7.4/dist/tf.min.js"></script>
  <script src="https://unpkg.com/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

  <!-- App script LAST (depends on the libraries above) -->
 <script>
  const MODEL_URL = './tm-model/';     // folder with model.json / metadata.json / weights.bin
  const IN_SIZE = 96;                   // model expects 96x96x1

  let tmModel, labels = [];
  let coreModel; // tf.LayersModel under the hood

  async function loadModel() {
    document.getElementById('label').textContent = 'Label: (loading model…)';
    document.getElementById('prob').textContent  = 'Confidence: —';
    tmModel = await tmImage.load(MODEL_URL + 'model.json', MODEL_URL + 'metadata.json');
    coreModel = tmModel.model; // raw tf.LayersModel
    if (tmModel.getClassLabels) labels = await tmModel.getClassLabels();
    document.getElementById('label').textContent = 'Label: (model ready)';
  }

  // Convert the current canvas image -> [1,96,96,1] grayscale tensor
  function makeInputTensor(fromCanvas) {
    return tf.tidy(() => {
      // [H,W,3] 0..255
      let t = tf.browser.fromPixels(fromCanvas);
      // Resize to 96x96
      t = tf.image.resizeBilinear(t, [IN_SIZE, IN_SIZE]);
      // Convert to grayscale: Y = 0.299 R + 0.587 G + 0.114 B
      const [r, g, b] = tf.split(t, 3, -1);
      const y = r.mul(0.299).add(g.mul(0.587)).add(b.mul(0.114)); // [96,96,1]
      // Normalize 0..1 and add batch dim: [1,96,96,1]
      return y.div(255).expandDims(0);
    });
  }

  async function predictFromCanvas() {
    if (!coreModel) return;
    const canvas = document.getElementById('canvas');
    const input = makeInputTensor(canvas);           // [1,96,96,1]
    const logits = coreModel.predict(input);         // tf.Tensor
    const probs = await logits.data();               // Float32Array
    input.dispose(); logits.dispose();

    // Find top class
    let topIdx = 0, topVal = -1;
    for (let i = 0; i < probs.length; i++) {
      if (probs[i] > topVal) { topVal = probs[i]; topIdx = i; }
    }
    const label = labels[topIdx] || `Class ${topIdx}`;
    document.getElementById('label').textContent = 'Label: ' + label;
    document.getElementById('prob').textContent  = 'Confidence: ' + (topVal * 100).toFixed(1) + '%';
  }
</script>

</body>
</html>
